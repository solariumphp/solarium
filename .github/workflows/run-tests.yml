name: Run Tests

on:
    push:

    pull_request:

    schedule:
        - cron: '0 8 * * *' # run at 08:00 UTC

jobs:
    run-tests:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                php: [7.2, 7.3, 7.4]
                solr: [7, 8]
                mode: [cloud, server]
                symfony: [4.3.*, 4.4.*, 5.0.*]

        name: PHP ${{ matrix.php }}, symfony ${{ matrix.symfony }}, Solr ${{ matrix.solr }} ${{ matrix.mode }}

        steps:
            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                php-version: ${{ matrix.php }}
                extensions: dom, curl, libxml, mbstring, zip, intl, iconv, json, simplexml
                ini-values: memory_limit=256M,post_max_size=256M
                coverage: pcov

            - name: Checkout solarium
              uses: actions/checkout@v2

            - name: Start Solr ${{ matrix.solr }} in ${{ matrix.mode }} mode
              run: |
                cd tests/Integration/Fixtures/docker/solr${{ matrix.solr }}_${{ matrix.mode }}
                docker-compose up -d

            - name: Install dependencies
              run: |
                composer global require hirak/prestissimo
                composer require --dev symfony/event-dispatcher:${{ matrix.symfony }}

            - name: Run tests
              run: |
                vendor/bin/phpstan analyze src/ tests/ --level=1
                vendor/bin/phpunit -c phpunit.xml --exclude-group skip_for_solr_${{ matrix.mode }} -v --coverage-clover coverage.xml

            - name: Coveralls Parallel
              uses: mkalkbrenner/github-action@master
              with:
                github-token: ${{ secrets.github_token }}
                flag-name: PHP_${{ matrix.php }}-symfony_${{ matrix.symfony }}-Solr_${{ matrix.solr }}_${{ matrix.mode }}
                parallel: true

    finish:
        needs: run-tests
        runs-on: ubuntu-latest
        steps:
          - name: Coveralls Finished
            uses: mkalkbrenner/github-action@master
            with:
              github-token: ${{ secrets.github_token }}
              parallel-finished: true

